<div class="box-body  table-responsive"  ng-controller="AgenceList">
    <table datatable="" dt-options="dtOptions" dt-columns="dtColumns" class="table table-striped table-bordered table-hover" id="dataTables-example" width="100%">
    </table>
</div>

<script type="text/javascript" >

    app.controller("AgenceList",
            function AgenceList($scope, $http, toaster, $state, ErrorService, $stateParams, DTColumnBuilder, DTOptionsBuilder, $modal, $log) {

                $scope.dtColumns = [
                    DTColumnBuilder.newColumn('code').withTitle('code').notVisible(),
                    DTColumnBuilder.newColumn('libelle').withTitle('Nom'),
                    DTColumnBuilder.newColumn('ville.libelle').withTitle('Ville'),
                    DTColumnBuilder.newColumn('adresse').withTitle('Adresse'),
                    DTColumnBuilder.newColumn('telephone1').withTitle('Telephone1'),
                    DTColumnBuilder.newColumn('telephone2').withTitle('Telephone2'),
                    DTColumnBuilder.newColumn('boite_postale').withTitle('BP')
                ];

                $scope.dtOptions = DTOptionsBuilder
                        .fromSource('Agence/list/' + $stateParams.id)
                        .withPaginationType('full')
                        .withBootstrap()
                        // Add Table tools compatibility
                        .withTableTools('vendor/jquery/datatables/copy_csv_xls.swf')
                        .withTableToolsOption("sRowSelect", "multi")
                        .withTableToolsButtons([
                            "addrow", "editrow", "delrow", "csv", "select_all", "select_none"
                        ])
                        ;


                $.fn.dataTable.TableTools.buttons.addrow = $.extend(
                        {}, $.fn.dataTable.TableTools.buttonBase,
                        {
                            "sButtonText": "<i class=\"fa fa-plus\"></i>",
                            "sToolTip": "New Data",
                            "fnClick": function (nButton, oConfig) {
                                $scope.openFormAgence('lg', -1);
                            }

                        }
                );
                $.fn.dataTable.TableTools.buttons.editrow = $.extend(
                        {}, $.fn.dataTable.TableTools.BUTTONS.select,
                        {
                            "sButtonText": "<i class=\"fa fa-edit\"></i>",
                            "sToolTip": "Edit Data",
                            "fnClick": function (nButton, oConfig) {
                                $scope.openFormAgence('lg', (this.fnGetSelectedData()[0]).code);
                            }
                        }
                );

                $.fn.dataTable.TableTools.buttons.delrow = $.extend(
                        {}, $.fn.dataTable.TableTools.BUTTONS.select,
                        {
                            "sButtonText": "<i class=\"fa fa-trash-o\"></i>",
                            "sToolTip": "Delete Data",
                            "fnClick": function (nButton, oConfig) {
                                //confirm dialogue
                                var r = confirm("Confirm ?");
                                if (r == true) {
                                    $http.get($scope.categorie + '/del/' + (this.fnGetSelectedData()[0]).code)
                                            .success(function (data) {
                                                toaster.pop("success", "Success", "Suppression Effectuée avec Succès");
                                                $('#dataTables-example').DataTable().ajax.reload();
                                            }).error(function (data) {
                                        toaster.pop("error", "Error", data);
                                        $('#dataTables-example').DataTable().ajax.reload();
                                    });
                                }
                                ;

                            }
                        }
                );


                $scope.openFormAgence = function (size, code) {
                    var modalInstance = $modal.open({
                        templateUrl: 'tpl/Agence_form.html',
                        controller: 'AgenceForm',
                        size: size,
                        resolve: {
                            code: function () {
                                return code;
                            }
                        }
                    });

                    modalInstance.result.then(function () {
                        $log.info('Modal closed at: ' + new Date());
//                    $state.reload();
                        $('#dataTables-example').DataTable().ajax.reload();
                    }, function () {
                        $log.info('Modal dismissed at: ' + new Date());
//                    $state.reload();
                        $('#dataTables-example').DataTable().ajax.reload();
                    });
                };


            });

    app.controller("AgenceForm",
            function AgenceForm($scope, $modalInstance, $http, toaster, ErrorService, $stateParams, code) {
                $scope.categorie = 'Agence';
                $scope.errorService = ErrorService;
                $scope.errorService.clear();

                $http.get($scope.categorie + '/find/' + code)
                        .success(function (data) {
                            $scope.tsoftitem = data;
                        });
                $http.get('Ville/list')
                        .success(function (data) {
                            $scope.villes = data;
                        });
                $scope.master = angular.copy($scope.tsoftitem);

                $scope.reset = function () {
                    $scope.tsoftitem = angular.copy($scope.master);
                    $scope.form.$setPristine();
                };

                $scope.del = function (code) {
                    var r = confirm("Confirm ?");
                    if (r == true) {
                        $http.get($scope.categorie + '/del/' + code)
                                .success(function (data) {
                                    toaster.pop("success", "Success", "Suppression Effectuée avec Succès");
                                }).error(function (data) {
                            toaster.pop("error", "Error", data);
                        });

                    }

                };

                $scope.save = function () {
                    $scope.errorService.setwaiting();
                    $http.post( $scope.categorie + '/save/' + $stateParams.id,$scope.tsoftitem)
                            .success(function (data) {
                                toaster.pop("success", "Success", "Operation Effectuée avec Succès");
                                $scope.errorService.setSucces();
                                $scope.closemodal();
                            });
                };

                $scope.closemodal = function () {
                    $modalInstance.dismiss('cancel');
                };




            });
</script>
